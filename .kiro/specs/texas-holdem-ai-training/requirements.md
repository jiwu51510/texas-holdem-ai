# 需求文档

## 简介

本系统旨在提供一个完整的德州扑克单挑（Heads-Up）游戏AI模型训练平台。系统将支持强化学习模型的训练、实时监控训练过程、策略分析和可视化等功能。通过该系统，用户可以训练出能够在单挑德州扑克中做出最优决策的AI代理。

**核心问题与解决方案：** 翻后（Postflop）阶段由于每个不同的公共牌面都代表一个新的游戏状态，策略学习结果非常稀疏，需要探索庞大的状态空间才能收敛。本系统引入Potential-Aware抽象方法，通过考虑手牌在所有未来轮次的强度分布轨迹（而非仅考虑最终轮的强度分布），将相似的信息集聚类在一起，从而大幅减少需要学习的状态空间，加速训练收敛。

## 术语表

- **训练系统（Training System）**：负责执行AI模型训练过程的核心系统
- **AI代理（AI Agent）**：参与德州扑克游戏并做出决策的智能体
- **单挑模式（Heads-Up Mode）**：两名玩家之间的德州扑克对局
- **训练回合（Training Episode）**：一次完整的游戏对局，从发牌到结束
- **策略网络（Policy Network）**：用于决定AI行动的神经网络
- **监控系统（Monitoring System）**：实时跟踪和显示训练指标的系统
- **策略查看器（Strategy Viewer）**：用于分析和可视化AI策略的工具
- **检查点（Checkpoint）**：保存的模型状态快照
- **训练指标（Training Metrics）**：衡量训练进度的数值，如胜率、奖励等
- **游戏状态（Game State）**：包含手牌、公共牌、筹码等信息的当前局面
- **行动空间（Action Space）**：AI可以执行的所有可能行动（弃牌、跟注、加注等）
- **信息集（Information Set）**：从玩家视角看不可区分的游戏状态集合
- **卡牌抽象（Card Abstraction）**：将相似的手牌组合归类到同一个"桶"（Bucket）中
- **Potential-Aware抽象**：考虑手牌在所有未来轮次强度分布轨迹的抽象方法
- **Distribution-Aware抽象**：仅考虑最终轮手牌强度分布的抽象方法
- **Earth Mover's Distance (EMD)**：用于计算两个分布之间距离的度量方法
- **手牌强度（Hand Strength）**：手牌相对于对手可能手牌的胜率
- **Equity分布**：手牌在不同公共牌面下的胜率分布直方图
- **桶（Bucket）**：卡牌抽象中的一个聚类，包含被认为相似的手牌组合
- **Imperfect Recall抽象**：允许玩家"忘记"之前已知信息的抽象方法

## 需求

### 需求 1：模型训练

**用户故事：** 作为研究人员，我想要训练德州扑克AI模型，以便开发出能够在单挑模式下做出最优决策的智能代理。

#### 验收标准

1. WHEN 用户启动训练会话时，THEN 训练系统 SHALL 初始化策略网络并开始自我对弈训练
2. WHEN 训练回合完成时，THEN 训练系统 SHALL 计算奖励并更新策略网络参数
3. WHEN 训练进行中时，THEN 训练系统 SHALL 每隔指定回合数自动保存检查点
4. WHEN 用户指定训练配置参数时，THEN 训练系统 SHALL 使用这些参数（学习率、批次大小、折扣因子等）执行训练
5. WHEN 训练达到指定回合数或用户手动停止时，THEN 训练系统 SHALL 安全终止训练并保存最终模型状态

### 需求 2：游戏环境模拟

**用户故事：** 作为系统开发者，我想要准确的德州扑克游戏环境模拟，以便AI能够在真实的游戏规则下进行训练。

#### 验收标准

1. WHEN 新回合开始时，THEN 训练系统 SHALL 按照德州扑克规则发放手牌和设置盲注
2. WHEN AI代理执行行动时，THEN 训练系统 SHALL 验证行动的合法性并更新游戏状态
3. WHEN 一手牌结束时，THEN 训练系统 SHALL 根据德州扑克规则判定胜负并分配筹码
4. WHEN 游戏进入不同阶段（翻牌前、翻牌、转牌、河牌）时，THEN 训练系统 SHALL 正确发放公共牌并管理下注轮次
5. WHEN 计算手牌强度时，THEN 训练系统 SHALL 准确识别所有牌型（高牌、对子、两对、三条、顺子、同花、葫芦、四条、同花顺）

### 需求 3：实时训练监控

**用户故事：** 作为研究人员，我想要实时监控训练进度和性能指标，以便及时发现问题并评估训练效果。

#### 验收标准

1. WHEN 训练正在进行时，THEN 监控系统 SHALL 每隔指定时间间隔更新并显示当前训练指标
2. WHEN 用户请求查看训练指标时，THEN 监控系统 SHALL 显示胜率、平均奖励、损失值和已完成回合数
3. WHEN 训练指标更新时，THEN 监控系统 SHALL 将数据持久化到日志文件中
4. WHEN 用户查看历史训练数据时，THEN 监控系统 SHALL 提供时间序列图表展示指标变化趋势
5. WHEN 训练出现异常（如损失值发散）时，THEN 监控系统 SHALL 发出警告通知

### 需求 4：策略分析与可视化

**用户故事：** 作为研究人员，我想要分析和可视化训练好的AI策略，以便理解AI的决策逻辑并评估策略质量。

#### 验收标准

1. WHEN 用户加载已训练的模型时，THEN 策略查看器 SHALL 读取模型参数并准备进行策略分析
2. WHEN 用户输入特定游戏状态时，THEN 策略查看器 SHALL 显示AI在该状态下各个行动的概率分布
3. WHEN 用户请求策略热图时，THEN 策略查看器 SHALL 生成并显示不同手牌组合的行动倾向可视化
4. WHEN 用户查询特定场景的决策时，THEN 策略查看器 SHALL 提供详细的决策理由和期望价值计算
5. WHEN 用户比较多个模型时，THEN 策略查看器 SHALL 并排显示不同模型在相同状态下的策略差异

### 需求 5：模型管理

**用户故事：** 作为研究人员，我想要管理训练过程中的模型版本，以便保存、加载和比较不同阶段的模型。

#### 验收标准

1. WHEN 训练系统保存检查点时，THEN 训练系统 SHALL 将模型参数、优化器状态和训练元数据存储到文件系统
2. WHEN 用户请求加载检查点时，THEN 训练系统 SHALL 恢复模型参数、优化器状态并继续训练
3. WHEN 用户列出可用模型时，THEN 训练系统 SHALL 显示所有检查点及其元数据（训练回合数、保存时间、性能指标）
4. WHEN 用户删除旧检查点时，THEN 训练系统 SHALL 从文件系统中移除指定的模型文件
5. WHEN 保存检查点时，THEN 训练系统 SHALL 使用唯一标识符命名文件以避免覆盖

### 需求 6：模型评估

**用户故事：** 作为研究人员，我想要评估训练好的模型性能，以便量化AI的实力并与基准策略比较。

#### 验收标准

1. WHEN 用户启动评估会话时，THEN 训练系统 SHALL 让目标模型与指定对手进行多局对弈
2. WHEN 评估对局完成时，THEN 训练系统 SHALL 计算并报告胜率、平均盈利和标准差
3. WHEN 用户指定基准策略（如随机策略、固定策略）时，THEN 训练系统 SHALL 使用该策略作为对手进行评估
4. WHEN 评估多个模型时，THEN 训练系统 SHALL 生成性能对比报告
5. WHEN 评估结果生成时，THEN 训练系统 SHALL 将结果保存到结构化文件中供后续分析

### 需求 7：训练配置管理

**用户故事：** 作为研究人员，我想要灵活配置训练参数，以便针对不同实验需求调整训练过程。

#### 验收标准

1. WHEN 用户创建训练配置时，THEN 训练系统 SHALL 接受并验证所有必需参数（学习率、网络架构、训练回合数等）
2. WHEN 配置参数无效时，THEN 训练系统 SHALL 拒绝配置并提供清晰的错误信息
3. WHEN 用户保存配置时，THEN 训练系统 SHALL 将配置序列化为JSON格式并存储到文件
4. WHEN 用户加载配置文件时，THEN 训练系统 SHALL 解析配置并应用到训练会话
5. WHEN 配置文件缺失可选参数时，THEN 训练系统 SHALL 使用合理的默认值

### 需求 8：并行训练支持

**用户故事：** 作为研究人员，我想要利用多核处理器并行训练，以便加速训练过程并提高资源利用率。

#### 验收标准

1. WHEN 用户启用并行训练时，THEN 训练系统 SHALL 在多个进程或线程中同时运行游戏模拟
2. WHEN 并行工作进程生成训练数据时，THEN 训练系统 SHALL 收集并聚合所有进程的经验数据
3. WHEN 更新策略网络时，THEN 训练系统 SHALL 确保参数更新的原子性和一致性
4. WHEN 用户指定工作进程数量时，THEN 训练系统 SHALL 创建相应数量的并行环境
5. WHEN 并行训练出现进程错误时，THEN 训练系统 SHALL 捕获异常并优雅地终止所有工作进程

### 需求 9：数据持久化

**用户故事：** 作为研究人员，我想要持久化训练数据和结果，以便进行离线分析和实验复现。

#### 验收标准

1. WHEN 训练回合完成时，THEN 训练系统 SHALL 将回合数据（状态、行动、奖励）写入训练日志
2. WHEN 用户查询历史训练数据时，THEN 训练系统 SHALL 从持久化存储中读取并返回请求的数据
3. WHEN 存储训练指标时，THEN 训练系统 SHALL 使用时间戳和回合编号作为索引
4. WHEN 磁盘空间不足时，THEN 训练系统 SHALL 检测到错误并通知用户
5. WHEN 用户导出训练数据时，THEN 训练系统 SHALL 生成标准格式（CSV或JSON）的数据文件

### 需求 10：命令行界面

**用户故事：** 作为研究人员，我想要通过命令行界面控制训练系统，以便在服务器环境中方便地执行训练任务。

#### 验收标准

1. WHEN 用户执行训练命令时，THEN 训练系统 SHALL 解析命令行参数并启动训练会话
2. WHEN 用户执行评估命令时，THEN 训练系统 SHALL 加载指定模型并运行评估
3. WHEN 用户执行策略查看命令时，THEN 策略查看器 SHALL 启动交互式界面或生成可视化报告
4. WHEN 命令行参数缺失或无效时，THEN 训练系统 SHALL 显示帮助信息和使用示例
5. WHEN 用户请求帮助时，THEN 训练系统 SHALL 列出所有可用命令及其说明

### 需求 11：Potential-Aware卡牌抽象

**用户故事：** 作为研究人员，我想要使用Potential-Aware抽象方法来减少翻后阶段的状态空间，以便加速训练收敛并提高策略质量。

#### 验收标准

1. WHEN 系统计算翻牌阶段的卡牌抽象时，THEN 抽象系统 SHALL 考虑手牌在转牌和河牌阶段的完整强度分布轨迹（而非仅考虑河牌阶段的最终强度分布）
2. WHEN 系统计算两个手牌组合之间的距离时，THEN 抽象系统 SHALL 使用Earth Mover's Distance (EMD)作为距离度量
3. WHEN 系统执行卡牌聚类时，THEN 抽象系统 SHALL 使用k-means算法将相似的手牌组合归入同一个桶
4. WHEN 用户指定每个游戏阶段的桶数量时，THEN 抽象系统 SHALL 生成相应数量的卡牌抽象桶
5. WHEN 系统生成抽象时，THEN 抽象系统 SHALL 支持Imperfect Recall（允许在后续轮次忘记之前可区分的信息）
6. WHEN 训练使用抽象后的状态空间时，THEN 训练系统 SHALL 将同一桶内的所有手牌组合视为等价状态

### 需求 12：手牌强度分布计算

**用户故事：** 作为系统开发者，我想要准确计算手牌在各个游戏阶段的强度分布，以便为Potential-Aware抽象提供基础数据。

#### 验收标准

1. WHEN 系统计算手牌的Equity分布时，THEN 抽象系统 SHALL 枚举所有可能的公共牌组合并计算对应的胜率
2. WHEN 系统生成Equity直方图时，THEN 抽象系统 SHALL 将胜率值划分为指定数量的区间（默认50个区间，每个区间宽度0.02）
3. WHEN 系统计算翻牌阶段的Potential-Aware特征时，THEN 抽象系统 SHALL 生成手牌在转牌阶段各个桶的分布直方图
4. WHEN 系统计算转牌阶段的特征时，THEN 抽象系统 SHALL 生成手牌在河牌阶段的Equity分布直方图
5. WHEN 系统计算河牌阶段的特征时，THEN 抽象系统 SHALL 直接计算手牌的最终Equity值

### 需求 13：EMD距离计算

**用户故事：** 作为系统开发者，我想要高效计算两个分布之间的Earth Mover's Distance，以便支持大规模的卡牌抽象计算。

#### 验收标准

1. WHEN 系统计算两个一维直方图之间的EMD时，THEN 抽象系统 SHALL 使用线性时间算法扫描直方图并累计需要移动的"土"的距离
2. WHEN 系统计算多维EMD（用于Potential-Aware抽象）时，THEN 抽象系统 SHALL 使用高效的近似算法以支持大规模计算
3. WHEN 系统计算桶之间的地面距离（Ground Distance）时，THEN 抽象系统 SHALL 使用下一轮次桶的EMD作为距离度量
4. WHEN EMD计算涉及稀疏直方图时，THEN 抽象系统 SHALL 利用稀疏性优化计算效率
5. WHEN 系统执行k-means聚类时，THEN 抽象系统 SHALL 使用EMD作为点与聚类中心之间的距离度量

### 需求 14：抽象预计算与缓存

**用户故事：** 作为研究人员，我想要预计算并缓存卡牌抽象结果，以便在训练时快速查询而无需重复计算。

#### 验收标准

1. WHEN 用户请求生成卡牌抽象时，THEN 抽象系统 SHALL 执行完整的抽象计算并将结果保存到文件
2. WHEN 训练系统启动时，THEN 训练系统 SHALL 加载预计算的抽象映射表
3. WHEN 系统查询手牌组合对应的桶ID时，THEN 抽象系统 SHALL 在O(1)时间内返回结果
4. WHEN 抽象配置参数改变时，THEN 抽象系统 SHALL 检测到配置变化并提示用户重新生成抽象
5. WHEN 系统保存抽象结果时，THEN 抽象系统 SHALL 同时保存抽象配置元数据（桶数量、距离度量类型等）

### 需求 15：抽象质量评估

**用户故事：** 作为研究人员，我想要评估卡牌抽象的质量，以便选择最优的抽象参数配置。

#### 验收标准

1. WHEN 用户请求评估抽象质量时，THEN 抽象系统 SHALL 计算并报告聚类的Within-Cluster Sum of Squares (WCSS)
2. WHEN 系统完成k-means聚类时，THEN 抽象系统 SHALL 报告每个桶的大小分布统计
3. WHEN 用户比较不同抽象配置时，THEN 抽象系统 SHALL 支持使用相同的随机种子进行可重复的比较实验
4. WHEN 系统生成抽象报告时，THEN 抽象系统 SHALL 包含每个游戏阶段的桶数量、平均桶大小和最大桶大小
